# UIP-24: CTOR - Canonical Transactions Ordering

```
Author:   Andres Correa Casablanca <andres@thirdhash.com>
Status:   Draft
Created: 2018-12-14
```

## Abstract

Remove the current TTOR (Topological Transactions Ordering) implicit rule, and
impose a canonical transactions ordering on blocks (transactions ordered by
their IDs in lexicographical order).


## Motivation

Currently, when a proposer builds a block, or a relay node validates a block, it
has to take into account the transactions topological order. This has some
implications:

*   It imposes some overhead at the time of adding transactions to the block
    template (the best known insertion algorithms for online topological
    ordering take `O(√m)` time, being `m` the number of possible edges)
    [[1][2]](#references).
*   Although it's possible to parallelize the validation with TTOR applying the
    OTI (outputs-then-inputs) algorithm by keeping track of the transactions
    indices [[3]](#references), the code becomes more complex and still requires
    an extra step to check that the TTOR rule is really applied (using OTI
    removes the previous implicit check).

However, using AOR (Any Ordering Rule) or CTOR can mitigate these two problems:

*   In the case of block creation, AOR would take O(1) time, while CTOR would
    need O(log2(n)) time, therefore, they are able to scale better as the block
    size increases.
*   In the case of block validation, the OTI algorithm is trivial to implement
    without requiring to keep track of transaction indices nor any extra check.

Is also worth to say that, in our case, with a target spacing (expected time
between blocks) of 16 seconds, the probability of having "0-conf" transactions
is even lower than in Bitcoin or Bitcoin Cash, so TTOR gives as little value.

On top of this, CTOR eases the introduction of better block propagation
techniques, like Graphene [[4][7]](#references), and allows for compact
transaction inclusion/exclusion proofs applying algorithms to tackle the "set
reconciliation problem" [[5][6]](#references).


## Specification

*   All block transactions (except for the coinbase transaction, which must be
    the first one) HAVE TO be in lexicographical order (using their ID as key).
*   The implementation MUST NOT rely on the topological order assumption in Any
    of its steps.
*   Using the OTI algorithm is a good starting point, but not mandatory (other
    variants, like parallel algorithms, are possible).

## Rationale

Some developers argued against implementing CTOR by exposing that there was
still potential for optimization on top of TTOR, but no real alternative to
Graphene has been proposed, and it's not a good engineering practice to
prioritize micro-optimizations over picking good algorithms and/or data
structures.

A different proposal is to use AOR, but AOR does not give us many of the
advantages that CTOR brings, like enabling the possibility of implementing
Graphene.

Prior research work on the topic has been done by the Bitcoin Cash community
[[6]](#reference), and CTOR has been implemented at November 2018 as a hard
fork. Although Gavin first proposed a different canonical order, the final
Bitcoin Cash implementation followed the simpler lexicographical order).


## Backwards compatibility

*   The new algorithm could lead to validation errors on old clients receiving
    blocks generated by updated nodes.
*   The new algorithm could lead to validation errors on new clients receiving
    blocks generated by not updated nodes.
*   Having said that, the first two points are not really important because
    Unit-e is still not public at the time of writing this document, so we don't
    have any test or main net running and there's no need to keep backwards
    compatibility.
*   For the same reason stated in the previous point, there's no need to
    maintain the old TTOR algorithm to validate as it is done in Bitcoin Cash.


## Reference implementation

Work in progress


## References

1.  [Practical performance of incremental topological sorting and cycle detection algorithms, 2016, Ragnar Lárus Sigurðsson](http://publications.lib.chalmers.se/records/fulltext/248308/248308.pdf)
2.  [Incremental Topological Sort and Cycle Detection in O(m sqrt(n)) Expected Total Time, Aaron Berstein, Shiri Chechik, January 2018](https://epubs.siam.org/doi/abs/10.1137/1.9781611975031.2)
3.  [Jonathan Toomin's proposal to apply OTI on top of TTOR](https://github.com/Bitcoin-ABC/bitcoin-abc/pull/244/files#diff-24efdb00bfbe56b140fb006b562cc70bR2222)
4.  [Graphene: A New Protocol for Block Propagation Using Set Reconciliation, 2017, A. Ozisik, G. Andresen, G. Bissias, A. Houmansadr, B. Levine](https://people.cs.umass.edu/~gbiss/graphene.pdf)
5.  [Set Reconciliation With Nearly Optimal Communication Complexity, 2000, Yaron Minsky, Ari Trachtenberg,IEEE, and Richard Zippe](https://pdfs.semanticscholar.org/be4e/60056b996b3df7ad71235aab133d304a38e3.pdf)
6.  [What’s the Difference? Efficient Set Reconciliation without Prior Contex, 2011, David Eppstein, Michael T. Goodrich, Frank Uyeda, George Varghese](https://www.ics.uci.edu/~eppstein/pubs/EppGooUye-SIGCOMM-11.pdf)
7. [O(1) Block Propagation, Gavin Andresen](https://gist.github.com/gavinandresen/e20c3b5a1d4b97f79ac2)

## Copyright

This document and all its auxiliary files are dual-licensed under
[CC0](https://creativecommons.org/publicdomain/zero/1.0/) and
[MIT](https://opensource.org/licenses/MIT).
