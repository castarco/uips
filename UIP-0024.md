# UIP-24: CTOR - Canonical Transactions Ordering

```
Author:   Andres Correa Casablanca <andres@thirdhash.com>
Status:   Draft
Created: 2018-12-14
```

## Abstract

Remove the current TTOR (Topological Transactions Ordering) implicit rule, and
impose a canonical transactions ordering on blocks (transactions ordered by
their IDs in lexicographical order).

## Motivation

Currently, when a proposer builds a block, or a relay node validates a block, it
has to take into account the transactions topological order. This has some
implications:

*   It imposes some overhead at the time of adding transactions to the block
    template (the best known insertion algorithms for online topological
    ordering take `O(√m)` time, being `m` the number of possible edges)
    [[1][2]](#references).
*   Although it's possible to parallelize the validation with TTOR applying the
    OTI (outputs-then-inputs) algorithm by keeping track of the transactions
    indices [[3]](#references), the code becomes more complex and still requires
    an extra step to check that the TTOR rule is really applied (using OTI
    removes the previous implicit check).

However, using AOR (Any Ordering Rule) or CTOR can mitigate these two problems:

*   In the case of block creation, AOR would take O(1) time, while CTOR would
    need O(log2(n)) time.
*   In the case of block validation, the OTI algorithm is trivial to implement
    without requiring to keep track of transaction indices nor any extra check.

On top of this, CTOR eases the introduction to better block propagation
techniques, like Graphene [[4]](#references), and allows for compact transaction
inclusion/exclusion proofs applying algorithms to tackle the "set reconciliation
problem" [[5][6]](#references).

## Specification

The technical specification should describe the syntax and semantics of any new
feature. The specification should be detailed enough to allow competing,
interoperable implementations for any of the current Unit-e platforms.


## Rationale

The rationale fleshes out the specification by describing what motivated the
design and why particular design decisions were made. It should describe
alternate designs that were considered and related work. The rationale should
provide evidence of consensus within the community and discuss important
objections or concerns raised during discussion.


## Backwards compatibility

All UIPs that introduce backwards incompatibilities must include a section
describing these incompatibilities and their severity. The UIP must explain how
the author proposes to deal with these incompatibilities.


## Reference implementation

A proposal MUST have a reference implementation before it can move from
`Draft` to `Proposed`. The terms "reference implementation" and
"proof-of-concept" can be used interchangeably here. The point is that the idea
has gone through a phase of implementation so that it is a tested idea, and
issues which only can be found when actually trying to implement it have been
found and addressed.

It is better to finish the specification and rationale first and reach consensus
on it before writing code, though.


## References

1.  [Practical performance of incremental topological sorting and cycle detection algorithms, 2016, Ragnar Lárus Sigurðsson](http://publications.lib.chalmers.se/records/fulltext/248308/248308.pdf)
2.  [Incremental Topological Sort and Cycle Detection in O(m sqrt(n)) Expected Total Time, Aaron Berstein, Shiri Chechik, January 2018](https://epubs.siam.org/doi/abs/10.1137/1.9781611975031.2)
3.  [Jonathan Toomin's proposal to apply OTI on top of TTOR](https://github.com/Bitcoin-ABC/bitcoin-abc/pull/244/files#diff-24efdb00bfbe56b140fb006b562cc70bR2222)
4.  [Graphene: A New Protocol for Block Propagation Using Set Reconciliation, 2017, A. Ozisik, G. Andresen, G. Bissias, A. Houmansadr, B. Levine](https://people.cs.umass.edu/~gbiss/graphene.pdf)
5.  [Set Reconciliation With Nearly Optimal Communication Complexity, 2000, Yaron Minsky, Ari Trachtenberg,IEEE, and Richard Zippe](https://pdfs.semanticscholar.org/be4e/60056b996b3df7ad71235aab133d304a38e3.pdf)
6.  [What’s the Difference? Efficient Set Reconciliation without Prior Contex, 2011, David Eppstein, Michael T. Goodrich, Frank Uyeda, George Varghese](https://www.ics.uci.edu/~eppstein/pubs/EppGooUye-SIGCOMM-11.pdf)

## Copyright

This document and all its auxiliary files are dual-licensed under
[CC0](https://creativecommons.org/publicdomain/zero/1.0/) and
[MIT](https://opensource.org/licenses/MIT).
